# 채팅 시스템 설계

### 목적

- 주로 SNS 기능

## 내용정리

**문제이해**

- 비디오 업로드, 스트리밍
  - (option) 댓글, 공유, 좋아요, 플레이리스트, 채널구독..
- 클라이언트 범위
  - 모바일 앱, 웹 브라우저, 스마트 TV
- DAU (500만)
- 다국어
- 해상도, 미디어 타입
- 암호화
- 비디오 사이즈

❗ 클라이언트끼리는 직접 통신하지 않는다.

**모듈**

- CDN
  - 비디오를 저장할 컴포넌트
- API서버
  - 비디오 스트리밍을 제외한 모든 요청을 처리할 컴포넌트

## 설계

- 비디오 업로드
  - 원본저장소 (BLOB)
  - 트랜스코딩 서버
  - 트랜스코딩 비디오 저장소 (BLOB)

## 프로세스

**비디오 업로드**

1. 비디오를 원본 저장소에 업로드
2. 트랜스코딩 서버가 원본 저장소에서 비디오를 가져와 트렌스코딩 시작
   ```
   ❓트랜스코딩 서버가 원본 저장소에서 비디오를 어떻게 가져오나??
   ```
3. 트랜스코딩이 완료되면, 두 절차가 병렬적으로 수행
   - 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
   - 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다
     - 트랜스코딩 완료 핸들러가 메타데이터 DB와 Cache를 갱신한다.
4. API 서버가 단말(업로더?) 에게 스트리밍 준비가 되었음을 알린다.

**메타데이터 갱신**

- 원본 저장소에 파일이 업로드 되는 동안. 메타데이터 갱신 작업이 병렬적으로 수행. 파일 이름, 크기, 포멧 등의 정보가 해당한다.

**비디오 스트리밍**

- `스트리밍 프로토콜`에 따라 지원하는 `비디오 인코딩`이 다르고, `플레이어`도 다르다.

## 상세 설계

**비디오 트랜스코딩**

- 가공되지 않은 원본 데이터는 저장 공간을 많이 차지한다.

- 대다수 단말과 브라우저는 특정 종류의 비디오 포멧만 지원. 호환성 문제를 해결하기 위해 비디오를 여러 포멧으로 인코딩해두는것이 바람직하다.

- 사용자에게 끊김 없는 고화질 비디오 재생을 보장하려면, 사용자의 네트워크 대역폭에 따라 저화질 - 고화질 비디오를 보내는 것이 바람직하다.

- 모바일 단말의 경우, 네트워크 상황이 수시로 달라질 수 있다. 비디오 화질을 자동으로 변경하거나, 수동으로 변경할 수 있도록 하는 것이 바람직하다.

인코딩 포멧

- 컨테이너
  - 비디오파일, 오디오, 메타데이터를 담는 바구니 같은것..
  - avi,mov,mp4
- 코덱
  - 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축/압축해제 알고리즘
  - H.264, VP9, HEVC

**유향 비순환 그래프(DAG) 모델**

- 검사
  - 좋은 품질의 비디오인가? , 비디오가 손상이 없는가?
- 인코딩
  - 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩
- 섬네일 추출
- ...
- 워터마크

**비디오 트랜스코딩 아키텍쳐**

**시스템 최적화**

## 생각

### 경험

### 키워드

- CDN
- BLOB 스토리지
- 스트리밍 프로토콜
  - MPEG-DASH
  - (애플) HLS
  - (마이크로소프트) 마이크로소프트 스무드 스트리밍 (Microsoft Smooth Streaming)
  - (어도비) 어도비 HTTP 동적 스트리밍 (Adobe HTTP Dynamic Streaming, HDS)
- bitrate (비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지)
- 인코딩 포멧
- DAG
